

# 业务需求

1. 用户在电商平台里平时通过购买商品、晒单评论可以有不断的积累积分
2. 积累到足够的积分后，就可以在电商平台的积分兑换页面中，选择使用自己的积分来兑换一些礼品

# 业务流程

积分模块：积分表，积分兑换表，

仓储模块：发货申请表，

第三方物流公司：物流单号

# 消息中间件引入

积分兑换是一个用户执行的操作，积分服务是没有必要同步调用仓储服务的。引入消息中间件进行异步化的解耦，保证用户点击积分兑换按钮之后，尽快返回。

# 重试机制

- 积分服务发送消息给可靠消息服务，可靠消息服务在消息表中新增记录，然后发送消息到MQ（消息中间件）
- 然后仓储服务消费消息新增发货申请单，如果成功就回调可靠消息服务的一个接口说自己成功了，可靠消息服务就可以更新本地消息表中的记录状态为成功
- 如果仓储服务长时间没通知可靠消息服务自己成功了，可靠消息服务不停的重试再次发送消息

# 幂等性

如果仓储服务卡在第三方物流系统申请物流单的环节，长时间阻塞，所以没回调通知可靠消息服务。但是可靠消息服务过了一段时间，感觉没收到回调通知，就自己重试发送了消息。因此我们还要保证仓储服务新增发货申请单的幂等性。

只要在“积分兑换表的id”字段上建立一个唯一索引就可以了，保证每个积分兑换记录只能创建一条发货申请单，如果重复创建就会被唯一索引被阻止，这样就可以保证这个行为的幂等性了。